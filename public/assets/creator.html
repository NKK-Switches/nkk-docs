<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="app.ico" type="image/x-icon"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Program Creator</title>
  <script src="https://unpkg.com/blockly@12.1.0/blockly.min.js"></script>
  <script src="https://unpkg.com/@blockly/field-slider@8.0.1/dist/index.js"></script>
  <script src="https://unpkg.com/@blockly/workspace-minimap@0.3.1/dist/index.js"></script>
  <script src="https://unpkg.com/@blockly/fixed-edges@6.0.1/dist/index.js"></script>
  <script src="https://unpkg.com/@blockly/field-bitmap@6.0.1/dist/index.js"></script>
  <script src="https://unpkg.com/@blockly/workspace-backpack@7.0.1/dist/index.js"></script>
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --accent: #00bfae;
      --bg: #181a1b;
      --card-bg: #23272a;
      --border: #2c2f33;
      --radius: 10px;
    }
    body {
      display: flex;
      height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    #blocklyDiv {
      flex: 2;
      background: var(--card-bg);
      border-right: 1px solid var(--border);
    }
    #blocklyMinimap {
      position: absolute;
      top: 10px;
      right: 360px;
      width: 200px;
      height: 150px;
      z-index: 10;
    }
    #preview {
      flex: 0 0 340px; /* Shorter width */
      max-width: 340px;
      min-width: 260px;
      border-left: 1px solid var(--border);
      padding: 24px 20px 20px 20px;
      overflow: auto;
      background: var(--card-bg);
      position: relative;
      color: var(--text);
    }
    #preview pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      background: #181a1b;
      color: var(--accent);
      border-radius: var(--radius);
      padding: 16px;
      font-size: 1rem;
      border: 1px solid var(--border);
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    .controls button {
      padding: 8px 18px;
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      width: 100%;
    }
    .controls button:hover {
      background: var(--primary-dark);
    }
    h3 {
      margin-top: 0;
      color: var(--accent);
      letter-spacing: 1px;
      font-weight: 600;
    }
    /* Modern scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      background: var(--card-bg);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }
    /* Blockly dark theme override */
     .blocklySvg {
      background: var(--bg) !important;
    }
    .blocklyMainBackground {
      stroke: var(--border) !important;
    }
    .blocklyToolboxDiv {
      background: var(--card-bg) !important;
      color: #222 !important; 
      border-right: 1px solid var(--border) !important;
    }
    .blocklyTreeLabel {
      color: #222 !important;  
      font-weight: 600 !important;
      letter-spacing: 0.5px;
    }
    .blocklyTreeRow {
      background: transparent !important;
    }
    .blocklyTreeSelected {
      background: var(--primary-dark) !important;
      color: #fff !important;
    }
    .blocklyTreeRow:hover {
      background: var(--primary) !important;
      color: #fff !important;
    }
    .blocklyFlyoutBackground {
      fill: var(--card-bg) !important;
      fill-opacity: 1 !important;
    }
    .blocklyScrollbarHandle {
      fill: var(--accent) !important;
    }
    .blocklyWidgetDiv .goog-menuitem-content {
      color: var(--text) !important;
    } 
    .label{
      color: white !important;
    }
  </style>
</head>
<body>
  <div id="blocklyDiv" style="height:100%; width:100%;"></div>
  <div id="blocklyMinimap" style="position:absolute;top:10px;right:360px;width:200px;height:150px;z-index:10;"></div>
  <div id="preview">
    <div class="controls">
      <button id="downloadBtn">Download JSON</button>
    </div>
    <h3>Configuration Program</h3>
    <pre id="jsonPreview">{"inputs": [], "outputs": []}</pre>
  </div>
  <div id="imagePreview" style="margin-top: 10px; text-align: center;"></div>

  <!-- The toolbox will be generated dynamically -->
  <xml id="toolbox" style="display: none"></xml>

  <script>
    // --- Frequently/Recently Used Categories Integration ---
    const allBlockTypes = [
      'input_block', 'output_block', 'state_block', 'condition_block',
      'timer_block', 'flag_block', 'channel_block', 'frequency_block',
      'state_option_output', 'state_option_duty', 'state_option_onDuration', 'state_option_offDuration',
      'state_option_clearBackground', 'state_option_rowMessage', 'state_option_font', 'state_option_invert',
      'state_option_color', 'state_option_colorBlink', 'state_option_brightness',
      'state_option_contrast', 'state_option_displayAnalog', 'state_option_displayTimer', 'state_option_displayFlag',
      'state_option_displayStopwatch', 'state_option_displayStopwatchDays', 'state_option_bitmap',
      'condition_option_pin', 'condition_option_state', 'condition_option_threshold', 'condition_option_comparison',
      'condition_option_thresholdRange', 'condition_option_thresholdVoltage', 'condition_option_thresholdPercent',
      'display_image', 'condition_option_switch', 'condition_option_timer'
    ];

    let mostUsed = [];
    let recentlyUsed = [];

    let fetchedImages = []; // Will hold array of image objects: {src, width, height, alt}

    // Call these once on page load

    function blockXml(type) {
      return `<block type="${type}"></block>`;
    }

    /*function imageBlock(img) {
      // Only generate the block if src is present and non-empty
      if (!img.src) return '';
      return `<block type="display_image">
        <field name="IMG">${img.src}</field>
      </block>`;
    }*/

    function getDynamicToolboxXml() {
      // Most used: top 5
      const most = mostUsed.slice(0, 5).map(blockXml).join('');
      // Recently used: last 5
      const recent = recentlyUsed.slice(-5).reverse().map(blockXml).join('');

      return `
        <xml>
          <category name="Inputs" colour="#5CA65C">
            <block type="input_block"></block>
          </category>
          <category name="Outputs" colour="#5C81A6">
            <block type="output_block"></block>
          </category>
          <category name="State Options" colour="#A65C40">
            <block type="state_block"></block>
            <block type="timer_action_block"></block>
            <block type="timer_duration_block"></block>
            <block type="timer_adjust_block"></block> 
            <block type="flag_block"></block>
            <block type="display_image"></block>
            <block type="state_option_output"></block>
            <block type="state_option_duty"></block>
            <block type="state_option_onDuration"></block>
            <block type="state_option_offDuration"></block>
            <block type="state_option_clearBackground"></block>
            <block type="state_option_rowMessage"></block>
            <block type="state_option_font"></block>
            <block type="state_option_invert"></block>
            <block type="state_option_color"></block>
            <block type="state_option_colorBlink"></block>
            <block type="state_option_brightness"></block>
            <block type="state_option_contrast"></block>
            <block type="state_option_stopwatch"></block>
            <block type="state_option_displayAnalog"></block>
            <block type="state_option_displayTimer"></block>
            <block type="state_option_displayFlag"></block>
            <block type="state_option_displayStopwatch"></block>
            <block type="state_option_displayStopwatchDays"></block>
          </category>
          <category name="Condition Options" colour="#287271">
            <block type="condition_block"></block>
            <block type="condition_option_pin"></block>
            <block type="condition_option_state"></block>
            <block type="condition_option_threshold"></block>
            <block type="condition_option_comparison"></block>
            <block type="condition_option_thresholdRange"></block>
            <block type="condition_option_thresholdVoltage"></block>
            <block type="condition_option_thresholdPercent"></block>
            <block type="condition_option_switch"></block>
            <block type="condition_option_timer"></block>
            <block type="condition_option_flag"></block>
          </category>
          <category name="Frequently Used" colour="#b0132d">
            ${most || '<label></label>'}
          </category>
          <category name="Recently Used" colour="#701391">
            ${recent || '<label></label>'}
          </category>
        </xml>
      `;
    }

    function updateToolbox() {
      const toolboxXml = Blockly.utils.xml.textToDom(getDynamicToolboxXml());
      workspace.updateToolbox(toolboxXml);
    }

    // Helper to update the dropdown options dynamically
  /*function updateImagePathDropdown(options) {
  // Find the block definition and update its dropdown options
  const block = Blockly.Blocks['display_image'];
  if (block && block.jsonInit) {
    // Update the block definition for future blocks
    block.jsonInit.args0[0].options = options;
  }
  // Update all existing blocks in the workspace
  if (window.workspace) {
    workspace.getAllBlocks().forEach(b => {
      if (b.type === 'display_image') {
        const field = b.getField('IMG');
        if (field && field.menuGenerator_) {
          field.menuGenerator_ = options;
          field.setValue(options[0] ? options[0][1] : '');
        }
      }
    });
  }
}*/

    // Fetch image paths dynamically and update the dropdown options
/*function fetchImagePaths() {
  fetch('/bitmap-list') // Replace with your backend endpoint
    .then(response => response.json())
    .then(data => {
      // Ensure data is an array of objects with "path" and "alt"
      const imagePaths = Array.isArray(data) ? data : [];
      window.imageOptions = imagePaths.length
        ? imagePaths.map(image => [image.alt, image.path]) // Use "alt" as the label and "path" as the value
        : [['No Images Available', '']];

      // Update the dropdown options dynamically
      updateImagePathDropdown(window.imageOptions);
    })
    .catch(error => {
      console.error('Failed to fetch image paths:', error);
      window.imageOptions = [['No Images Available', '']];
      updateImagePathDropdown(window.imageOptions);
    });
}*/

// Call the function to fetch image paths on page load
//fetchImagePaths();

    // Define all custom Blockly blocks
    Blockly.defineBlocksWithJsonArray([
      {
        type: 'input_block',
        message0: 'Input name %1 pin %2 type %3 pull %4',
        args0: [
          { type: 'field_input', name: 'NAME', text: 'in1' },
          { type: 'field_number', name: 'PIN', value: 0, min: 0 },
          { type: 'field_dropdown', name: 'TYPE', options: [['analog','analog'],['digital','digital']] },
          { type: 'field_dropdown', name: 'PULL', options: [['DNP',''],['up','up'],['down','down']] }
        ],
        colour: 92
      },
      {
        type: 'output_block',
        message0: 'Output name %1 pin %2 type %3 %4 Frequency %5',
        args0: [
          { type: 'field_input', name: 'NAME', text: 'out1' },
          { type: 'field_number', name: 'PIN', value: -1, min: -1 },
          { type: 'field_dropdown', name: 'TYPE', options: [['digital', 'digital'], ['pwm', 'pwm']] },
          { 
            type: 'field_dropdown', 
            name: 'CHANNEL', 
            options: [
              ['Channel 1', '1'],
              ['Channel 2', '2'],
              ['Channel 3', '3'],
              ['Channel 4', '4'],
              ['Channel 5', '5'],
              ['Channel 6', '6'],
              ['Channel 7', '7'],
              ['Channel 8', '8'],
              ['Channel 9', '9'],
              ['Channel 10', '10']
            ]
          },
          { type: 'field_number', name: 'FREQUENCY', value: 1000, min: 1 }
        ],
        message1: 'States %1',
        args1: [{ type: 'input_statement', name: 'STATES' }],
        message2: 'Conditions %1',
        args2: [{ type: 'input_statement', name: 'CONDITIONS' }],
        colour: 190,
        previousStatement: null,
        nextStatement: null,
        onchange: function(event) {
          // Always update visibility on any change or on block creation
          if (event && event.blockId !== this.id && event.type !== Blockly.Events.BLOCK_CREATE) return;
          const type = this.getFieldValue('TYPE');
          const channelField = this.getField('CHANNEL');
          const frequencyField = this.getField('FREQUENCY');
          const show = type === 'pwm';
          if (channelField) channelField.setVisible(show);
          if (frequencyField) frequencyField.setVisible(show);
          this.render();
        }
      },
      {
        type: 'state_block',
        message0: 'State',
        args0: [],
        message1: 'Timers %1',
        args1: [{ type: 'input_statement', name: 'TIMERS' }],
        message2: 'Flags %1',
        args2: [{ type: 'input_statement', name: 'FLAGS' }],
        message3: 'Options %1',
        args3: [{ type: 'input_statement', name: 'OPTIONS' }],
        colour: 260,
        previousStatement: null,
        nextStatement: null
      },
      {
        type: 'condition_block',
        message0: 'Condition',
        args0: [],
        message1: 'Options %1',
        args1: [{ type: 'input_statement', name: 'COND_OPTIONS' }],
        colour: 20,
        previousStatement: null,
        nextStatement: null
      },
      {
        type: 'timer_block',
        message0: 'Timer %1 Action %2 Duration (ms) %3',
        args0: [
          { 
            type: 'field_number', 
            name: 'TIMER_INDEX', 
            value: 1, min: 1, max: 12 
          },
          { 
            type: 'field_dropdown', 
            name: 'TIMER_ACTION', 
            options: [
              ['start', 'start'],
              ['stop', 'stop'],
              ['restart', 'restart'],
              ['pause', 'pause'],
              ['resume', 'resume']
            ]
          },
          { type: 'field_number', name: 'DURATION', value: 0, min: 0 }
        ],
        previousStatement: null,
        nextStatement: null,
        colour: 230
      },
      {
        type: 'flag_block',
        message0: ' %1 Action %2 Value %3',
        args0: [
          {
            type: 'field_dropdown',
            name: 'FLAG_INDEX',
            options: [
              ['Flag 1', '1'],
              ['Flag 2', '2'],
              ['Flag 3', '3'],
              ['Flag 4', '4'],
              ['Flag 5', '5'],
              ['Flag 6', '6'],
              ['Flag 7', '7'],
              ['Flag 8', '8'],
              ['Flag 9', '9'],
              ['Flag 10', '10'],
              ['Flag 11', '11'],
              ['Flag 12', '12']
            ]
          },
          {
            type: 'field_dropdown',
            name: 'FLAG_ACTION',
            options: [
              ['NONE', ''],
              ['=', '='],
              ['+=', '+='],
              ['-=', '-='],
              ['++', '++'],
              ['--', '--']
            ]
          },
          {
            type: 'field_number',
            name: 'FLAG_VALUE',
            value: 0, // Default value
            min: -10000, // Minimum value
            max: 10000  // Maximum value
          }
        ],
        previousStatement: null,
        nextStatement: null,
        colour: 120
      },
      {
        type: 'channel_block',
        message0: 'Channel number %1',
        args0: [{ type: 'field_number', name: 'CHANNEL_INDEX', value: 1, min: 1, max: 12 }],
        colour: 330,
        previousStatement: null,
        nextStatement: null
      },
      {
        type: 'frequency_block',
        message0: 'Frequency (Hz) %1',
        args0: [{ type: 'field_number', name: 'FREQ_VALUE', value: 1000, min: 1 }],
        colour: 340,
        previousStatement: null,
        nextStatement: null
      },
      { type: 'state_option_stopwatch', message0: 'Stopwatch %1', args0: [{ type: 'field_dropdown', name: 'STOPWATCH', options: [['Start','start'],['Stop','stop'],['Pause','pause'],['Resume','resume']] }], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_output', message0: 'Output %1', args0: [{ type: 'field_dropdown', name: 'OUTPUT', options: [['LOW','LOW'],['HIGH','HIGH']] }], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_duty', message0: 'Duty %1', args0: [{ type: 'field_number', name: 'DUTY', value: 128, min: 0, max: 255 }], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_onDuration', message0: 'OnDuration %1', args0: [{ type: 'field_number', name: 'ONDUR', value: 1000, min: 0 }], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_offDuration', message0: 'OffDuration %1', args0: [{ type: 'field_number', name: 'OFFDUR', value: 1000, min: 0 }], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_clearBackground', message0: 'ClearBackground %1', args0: [{ type: 'field_checkbox', name: 'CLEAR', "checked": true}], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_rowMessage', message0: 'Row%1Message %2', args0: [{ type: 'field_number', name: 'ROW', value: 1, min: 1, max: 3 }, { type: 'field_input', name: 'MSG', text: 'Hello' }], colour: 290, previousStatement: null, nextStatement: null },
      { 
        type: 'state_option_font', 
        message0: 'Font %1', 
        args0: [
          { type: 'field_dropdown', name: 'FONT', options: [['6x8', '0'], ['9x12', '1']] }
        ], 
        colour: 290, 
        previousStatement: null, 
        nextStatement: null 
      },
      { 
       type: 'state_option_invert', 
       message0: 'Invert %1', 
       args0: [
         { type: 'field_checkbox', name: 'INV', "checked": true }
       ], 
       colour: 290, 
       previousStatement: null, 
       nextStatement: null },
      { type: 'state_option_color', message0: 'Color %1', args0: [
        {
          type: 'field_dropdown',
          name: 'COLOR',
          options: [
            ['OFF', '0'], ['DARK RED', '1'], ['RED', '2'], ['DARK GREEN', '3'], ['DARK YELLOW', '4'],
            ['ORANGE', '5'], ['GREEN', '6'], ['LIME', '7'], ['YELLOW', '8'], ['DARK BLUE', '9'],
            ['DARK MAGENTA', '10'], ['PINK', '11'], ['DARK CYAN', '12'], ['GRAY', '13'], ['LIGHT RED', '14'],
            ['AQUA', '15'], ['LIGHT GREEN', '16'], ['LIGHT YELLOW', '17'], ['BLUE', '18'], ['PURPLE', '19'],
            ['MAGENTA', '20'], ['TEAL', '21'], ['LIGHT BLUE', '22'], ['LIGHT MAGENTA', '23'], ['CYAN', '24'],
            ['LIGHT CYAN', '25'], ['WHITE', '26']
          ]
        }
      ], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_colorBlink', message0: 'Color1 %1 Color2 %2 Dur1 %3 Dur2 %4', args0: [
        {
          type: 'field_dropdown',
          name: 'C1',
          options: [
            ['OFF', '0'], ['DARK RED', '1'], ['RED', '2'], ['DARK GREEN', '3'], ['DARK YELLOW', '4'],
            ['ORANGE', '5'], ['GREEN', '6'], ['LIME', '7'], ['YELLOW', '8'], ['DARK BLUE', '9'],
            ['DARK MAGENTA', '10'], ['PINK', '11'], ['DARK CYAN', '12'], ['GRAY', '13'], ['LIGHT RED', '14'],
            ['AQUA', '15'], ['LIGHT GREEN', '16'], ['LIGHT YELLOW', '17'], ['BLUE', '18'], ['PURPLE', '19'],
            ['MAGENTA', '20'], ['TEAL', '21'], ['LIGHT BLUE', '22'], ['LIGHT MAGENTA', '23'], ['CYAN', '24'],
            ['LIGHT CYAN', '25'], ['WHITE', '26']
          ]
        },
        {
          type: 'field_dropdown',
          name: 'C2',
          options: [
            ['OFF', '0'], ['DARK RED', '1'], ['RED', '2'], ['DARK GREEN', '3'], ['DARK YELLOW', '4'],
            ['ORANGE', '5'], ['GREEN', '6'], ['LIME', '7'], ['YELLOW', '8'], ['DARK BLUE', '9'],
            ['DARK MAGENTA', '10'], ['PINK', '11'], ['DARK CYAN', '12'], ['GRAY', '13'], ['LIGHT RED', '14'],
            ['AQUA', '15'], ['LIGHT GREEN', '16'], ['LIGHT YELLOW', '17'], ['BLUE', '18'], ['PURPLE', '19'],
            ['MAGENTA', '20'], ['TEAL', '21'], ['LIGHT BLUE', '22'], ['LIGHT MAGENTA', '23'], ['CYAN', '24'],
            ['LIGHT CYAN', '25'], ['WHITE', '26']
          ]
        },
        { type: 'field_number', name: 'D1', value: 1000, min: 0 },
        { type: 'field_number', name: 'D2', value: 1000, min: 0 }
      ], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_brightness', message0: 'Brightness %1', args0: [
        { type: 'field_slider', name: 'BR', value: 5, min: 0, max: 10, precision: 1 }
      ], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_contrast', message0: 'Contrast %1', args0: [
        { type: 'field_slider', name: 'CT', value: 5, min: 0, max: 10, precision: 1 }
      ], colour: 290, previousStatement: null, nextStatement: null },
      { type: 'state_option_displayAnalog', message0: 'Display Analog %1 pin %2 font %3 row %4', args0: [
        { type: 'field_dropdown', name: 'MODE', options: [['Voltage', 'voltage'], ['Percent', 'percent'], ['BarGraph', 'barGraph'], ['Fraction', 'fraction'], ['Value', 'value']] },
        { type: 'field_number', name: 'APIN', value: 0, min: 0 },
        { type: 'field_dropdown', name: 'AFONT', options: [['6x8', '0'], ['9x12', '1']] },
        { type: 'field_number', name: 'AROW', value: 1, min: 1, max: 3 },
        
      ],
      mutator: 'display_analog_mutator',
      previousStatement: null,
      nextStatement: null,
      colour: 280 },
      {
        type: 'state_option_displayTimer', 
        message0: 'Display %1 font %2 row %3', 
        args0: [
          { 
            type: 'field_dropdown', 
            name: 'TIMER', 
            options: [
              ['Timer 1', '1'],
              ['Timer 2', '2'],
              ['Timer 3', '3'],
              ['Timer 4', '4'],
              ['Timer 5', '5'],
              ['Timer 6', '6'],
              ['Timer 7', '7'],
              ['Timer 8', '8']
            ] 
          },
        { type: 'field_dropdown', name: 'FONT', options: [['6x8', '0'], ['9x12', '1']] },
        { type: 'field_number', name: 'ROW', value: 1, min: 1, max: 3 }
        ], colour: 290, previousStatement: null, nextStatement: null 
      },
      {
        type: 'state_option_displayFlag', 
        message0: 'Display %1 font %2 row %3', 
        args0: [
        { 
          type: 'field_dropdown', 
          name: 'FLAG', 
          options: [
              ['Flag 1', '1'],
              ['Flag 2', '2'],
              ['Flag 3', '3'],
              ['Flag 4', '4'],
              ['Flag 5', '5'],
              ['Flag 6', '6'],
              ['Flag 7', '7'],
              ['Flag 8', '8'],
              ['Flag 9', '9'],
              ['Flag 10', '10'],
              ['Flag 11', '11'],
              ['Flag 12', '12']
            ]
        },
        { type: 'field_dropdown', name: 'FONT', options: [['6x8', '0'], ['9x12', '1']] },
        { type: 'field_number', name: 'ROW', value: 1, min: 1, max: 3 }
      ], 
        previousStatement: null, 
        nextStatement: null, 
        colour: 295 
      },
      { type: 'state_option_displayStopwatch', message0: 'Display Stopwatch font %1 row %2', args0: [
        { type: 'field_dropdown', name: 'FONT', options: [['6x8', '0'], ['9x12', '1']] },
        { type: 'field_number', name: 'ROW', value: 1, min: 1, max: 3 }
      ], colour: 300, previousStatement: null, nextStatement: null },
      { type: 'state_option_displayStopwatchDays', message0: 'Display Stopwatch Days font %1 row %2', args0: [
        { type: 'field_dropdown', name: 'FONT', options: [['6x8', '0'], ['9x12', '1']] },
        { type: 'field_number', name: 'ROW', value: 1, min: 1, max: 3 }
      ], colour: 305, previousStatement: null, nextStatement: null },
      { type: 'state_option_bitmap', message0: 'Bitmap %1', 
      args0: [
        { type: 'field_bitmap', name: 'BITMAP', value: [],
        buttons:{
          randomize: false,
          clear: false,
        },
        width: 36,
        height: 24,
        fieldHeight: 75,
        output: null
       }
      ], colour: 290, previousStatement: null, nextStatement: null },
      {
        type: 'display_image',
        message0: 'Image Name %1',
        args0: [
         {
          type: 'field_input',
          name: 'IMG',
          text: ''
        }
        ],
        colour: 160,
        previousStatement: null,
        nextStatement: null
      },
      { type: 'condition_option_pin', message0: 'Pin %1', args0: [{ type: 'field_number', name: 'PIN', value: 0, min: 0 }], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_state', message0: 'State %1', args0: [{ type: 'field_dropdown', name: 'STATE', options: [['LOW', 'LOW'], ['HIGH', 'HIGH']] }], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_threshold', message0: 'Threshold %1', args0: [{ type: 'field_number', name: 'THRESHOLD', value: 0 }], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_comparison', message0: 'Comparison %1', args0: [{ type: 'field_dropdown', name: 'COMPARISON', options: [['less', 'less'], ['greater', 'greater'], ['equal', 'equal']] }], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_thresholdRange', message0: 'Threshold Range min %1 max %2', args0: [
        { type: 'field_number', name: 'MIN', value: 0 },
        { type: 'field_number', name: 'MAX', value: 100 }
      ], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_thresholdVoltage', message0: 'Threshold Voltage min %1 max %2', args0: [
        { type: 'field_number', name: 'VMIN', value: 0 },
        { type: 'field_number', name: 'VMAX', value: 5 }
      ], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_thresholdPercent', message0: 'Threshold Percent min %1 max %2', args0: [
        { type: 'field_number', name: 'PMIN', value: 0 },
        { type: 'field_number', name: 'PMAX', value: 100 }
      ], colour: 40, previousStatement: null, nextStatement: null },
      { type: 'condition_option_switch', message0: 'Switch %1', args0: [
        {
          type: 'field_dropdown',
          name: 'SWITCH_STATE',
          options: [
            ['Pressed', 'pressed'],
            ['Released', 'released'],
            ['Held', 'held'],
            ['Held Released', 'heldReleased']
          ]
        }
      ], colour: 40, previousStatement: null, nextStatement: null },
      {
        type: 'condition_option_timer',
        message0: ' %1 State %2',
        args0: [
          {
            type: 'field_dropdown',
            name: 'TIMER_NUMBER',
            options: [
              ['Timer 1', '1'],
              ['Timer 2', '2'],
              ['Timer 3', '3'],
              ['Timer 4', '4'],
              ['Timer 5', '5'],
              ['Timer 6', '6'],
              ['Timer 7', '7'],
              ['Timer 8', '8']
            ]
          },
          {
            type: 'field_dropdown',
            name: 'TIMER_STATE',
            options: [
              ['Expired', 'expired'],
              ['Running', 'running'],
              ['Paused', 'paused'],
              ['Stopped', 'stopped']
            ]
          }
        ],
        colour: 40,
        previousStatement: null,
        nextStatement: null
      },
      {
        type: 'condition_option_flag',
        message0: '%1 Value %2',
        args0: [
          {
            type: 'field_dropdown',
            name: 'FLAG_INDEX',
            options: [
              ['Flag 1', '1'],
              ['Flag 2', '2'],
              ['Flag 3', '3'],
              ['Flag 4', '4'],
              ['Flag 5', '5'],
              ['Flag 6', '6'],
              ['Flag 7', '7'],
              ['Flag 8', '8'],
              ['Flag 9', '9'],
              ['Flag 10', '10'],
              ['Flag 11', '11'],
              ['Flag 12', '12']
            ]
          },
          {
            type: 'field_number',
            name: 'FLAG_VALUE',
            value: 0, // Default value
            min: -10000, // Minimum value (adjust as needed)
            max: 10000  // Maximum value (adjust as needed)
          }
        ],
        colour: 40,
        previousStatement: null,
        nextStatement: null
      },
      {
        type: 'timer_action_block',
        message0: '%1 Action %2',
        args0: [
          { 
            type: 'field_dropdown', 
            name: 'TIMER_INDEX', 
            options: [
            ['Timer 1', '1'],
            ['Timer 2', '2'],
            ['Timer 3', '3'],
            ['Timer 4', '4'],
            ['Timer 5', '5'],
            ['Timer 6', '6'],
            ['Timer 7', '7'],
            ['Timer 8', '8']
          ]
          },
          {
            type: 'field_dropdown',
            name: 'TIMER_ACTION',
            options: [
              ['start', 'start'],
              ['stop', 'stop'],
              ['restart', 'restart'],
              ['pause', 'pause'],
              ['resume', 'resume']
            ]
          }
        ],
        previousStatement: null,
        nextStatement: null,
        colour: 230
      },
      {
        type: 'timer_duration_block',
        message0: '%1 Duration (ms) %2',
        args0: [
          { 
            type: 'field_dropdown', 
            name: 'TIMER_INDEX', 
            options: [
            ['Timer 1', '1'],
            ['Timer 2', '2'],
            ['Timer 3', '3'],
            ['Timer 4', '4'],
            ['Timer 5', '5'],
            ['Timer 6', '6'],
            ['Timer 7', '7'],
            ['Timer 8', '8']
          ] 
          },
          { type: 'field_number', name: 'DURATION', value: 0, min: 0 }
        ],
        previousStatement: null,
        nextStatement: null,
        colour: 230
      },
      Blockly.Blocks['timer_adjust_block'] = {
  init: function () {
    this.jsonInit({
      message0: '%1 Duration %2 Value %3',
      args0: [
        {
          type: 'field_dropdown',
          name: 'TIMER_INDEX',
          options: [
            ['Timer 1', '1'],
            ['Timer 2', '2'],
            ['Timer 3', '3'],
            ['Timer 4', '4'],
            ['Timer 5', '5'],
            ['Timer 6', '6'],
            ['Timer 7', '7'],
            ['Timer 8', '8']
          ]
        },
        {
          type: 'field_dropdown',
          name: 'TIMER_OPERATION',
          options: [
            ['=', '='],
            ['+=', '+='],
            ['-=', '-=']
          ]
        },
        {
          type: 'field_number',
          name: 'TIMER_VALUE',
          value: 0, // Default value
          min: -10000, // Minimum value
          max: 10000  // Maximum value
        }
      ],
      previousStatement: null,
      nextStatement: null,
      colour: 230
    });
  }
}
    ]);

    // After block creation, add this validator:
    Blockly.Blocks['flag_block'] = {
      init: function () {
        this.jsonInit({
          message0: '%1 Action %2 Value %3',
          args0: [
            {
              type: 'field_dropdown',
              name: 'FLAG_INDEX',
              options: [
                ['Flag 1', '1'],
                ['Flag 2', '2'],
                ['Flag 3', '3'],
                ['Flag 4', '4'],
                ['Flag 5', '5'],
                ['Flag 6', '6'],
                ['Flag 7', '7'],
                ['Flag 8', '8'],
                ['Flag 9', '9'],
                ['Flag 10', '10'],
                ['Flag 11', '11'],
                ['Flag 12', '12']
              ]
            },
            {
              type: 'field_dropdown',
              name: 'FLAG_ACTION',
              options: [
                ['=', '='],
                ['+=', '+='],
                ['-=', '-='],
                ['++', '++'],
                ['--', '--']
              ]
            },
            {
              type: 'field_number',
              name: 'FLAG_VALUE',
              value: 0, // Default value
              min: -10000, // Minimum value
              max: 10000, // Maximum value
            }
          ],
          previousStatement: null,
          nextStatement: null,
          colour: 120
        });

        // Dynamically show/hide the FLAG_VALUE input based on FLAG_ACTION
        this.setOnChange(function () {
          const action = this.getFieldValue('FLAG_ACTION'); // Get the selected action
          const valueInput = this.getField('FLAG_VALUE'); // Get the number input field

          // Show FLAG_VALUE for NONE, +=, -=
          if (action === '=' || action === '+=') {
            if (valueInput) valueInput.setVisible(true);
          } else if (action === '-=') {
            if (valueInput) valueInput.setVisible(true);
          } else {
            // Hide FLAG_VALUE for other actions
            if (valueInput) valueInput.setVisible(false);
          }

          this.render(); // Re-render the block to apply visibility changes
        });
      }
    };

    // Toggle Channel/Frequency visibility in output_block
    Blockly.Extensions.register('outputTypeToggleExtension', function() {
      const channelInput = this.getInput('CHANNEL');
      const frequencyInput = this.getInput('FREQUENCY');

      // Initially hide Channel and Frequency inputs
      if (channelInput) channelInput.setVisible(false);
      if (frequencyInput) frequencyInput.setVisible(false);

      this.setOnChange(function(event) {
        if (event.type === Blockly.Events.BLOCK_CHANGE && event.blockId === this.id && event.name === 'TYPE') {
          const isPwm = this.getFieldValue('TYPE') === 'pwm';

          // Toggle visibility based on the selected type
          if (channelInput) channelInput.setVisible(isPwm);
          if (frequencyInput) frequencyInput.setVisible(isPwm);

          this.render(); // Re-render the block to apply visibility changes
        }
      });
    });

    // Register the mutator for dynamic input
    Blockly.Extensions.registerMutator('display_analog_mutator', {
      mutationToDom: function() {
        const container = document.createElement('mutation');
        container.setAttribute('mode', this.getFieldValue('MODE'));
        return container;
      },
      domToMutation: function(xmlElement) {
        this.updateShape_(xmlElement.getAttribute('mode'));
      },
      onchange: function(e) {
        if (e && e.blockId === this.id && e.name === 'MODE') {
          this.updateShape_(this.getFieldValue('MODE'));
        }
      },
      updateShape_: function(mode) {
        // Remove levels input if it exists
        if (this.getInput('LEVELS')) {
          this.removeInput('LEVELS');
        }
          const parentOptions = [
          ['1', '1'],
          ['2', '2'],
          ['3', '3'],
          ['4', '4'],
          ['5', '5'],
          ['6', '6'],
          ['7', '7'],
          ['8', '8'],
          ['9', '9'],
          ['10', '10'],
          ['11', '11'],
          ['12', '12'],
          ['13', '13'],
          ['14', '14'],
          ['15', '15'],
          ['16', '16'],
          ['17', '17'],
          ['18', '18'],
          ['19', '19'],
          ['20', '20'],
          ['21', '21'],
          ['22', '22'],
          ['23', '23'],
          ['24', '24'],
          ['25', '25'],
          ['26', '26'],
          ['27', '27'],
          ['28', '28'],
          ['29', '29'],
          ['30', '30'],
          ['31', '31'],
          ['32', '32'],
          ['33', '33'],
          ['34', '34'],
          ['35', '35'],
          ['36', '36'],
          ['37', '37'],
          ['38', '38'],
          ['39', '39'],
          ['40', '40'],
          ['41', '41'],
          ['42', '42'],
          ['43', '43'],
          ['44', '44'],
          ['45', '45'],
          ['46', '46'],
          ['47', '47'],
          ['48', '48'],
          ['49', '49'],
          ['50', '50'],
          ['51', '51'],
          ['52', '52'],
          ['53', '53'],
          ['54', '54'],
          ['55', '55'],
          ['56', '56'],
          ['57', '57'],
          ['58', '58'],
          ['59', '59'],
          ['60', '60'],
          ['61', '61'],
          ['62', '62'],
          ['63', '63'],
          ['64', '64'],
          ['65', '65'],
          ['66', '66'],
          ['67', '67'],
          ['68', '68'],
          ['69', '69'],
          ['70', '70'],
          ['71', '71'],
          ['72', '72'],
          ['73', '73'],
          ['74', '74'],
          ['75', '75'],
          ['76', '76'],
          ['77', '77'],
          ['78', '78'],
          ['79', '79'],
          ['80', '80'],
          ['81', '81'],
          ['82', '82'],
          ['83', '83'],
          ['84', '84'],
          ['85', '85'],
          ['86', '86'],
          ['87', '87'],
          ['88', '88'],
          ['89', '89'],
          ['90', '90'],
          ['91', '91'],
          ['92', '92'],
          ['93', '93'],
          ['94', '94'],
          ['95', '95'],
          ['96', '96'],
          ['97', '97'],
          ['98', '98'],
          ['99', '99'],
        ];
        const parentFieldName = 'LEVELS_NUM';
      
        // Add levels input only if mode is 'fraction'
        if (mode === 'fraction') {
          this.appendDummyInput('LEVELS')
            .appendField('levels')
            .appendField(new Blockly.FieldDropdown(parentOptions), parentFieldName);
        }
      }
    })

    // Configure fixed edges
    FixedEdgesMetricsManager.setFixedEdges({
      top: true,
      left: true,
    });

    // Inject workspace with zoom controls and dynamic toolbox
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: Blockly.utils.xml.textToDom(getDynamicToolboxXml()),
      renderer: 'thrasos',
      scrollbars: true,
      trashcan: true,
      zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
      plugins: { metricsManager: FixedEdgesMetricsManager }
    });
    
    const defaultOptions = {
    allowEmptyBackpackOpen: true,
    useFilledBackpackImage: true,
    skipSerializerRegistration: false,
    contextMenu: {
      emptyBackpack: false,
      removeFromBackpack: true,
      copyToBackpack: true,
      copyAllToBackpack: true,
      pasteAllToBackpack: true,
      disablePreconditionChecks: false,
    },
  };
    
    const backpack = new Backpack(workspace, defaultOptions);
    backpack.init();

    // Initialize the minimap plugin (correct usage)
      const minimap = new PositionedMinimap(workspace);
      minimap.init();


    // Update toolbox on block usage
    workspace.addChangeListener(function(event) {
      if (event.type === Blockly.Events.BLOCK_CREATE) {
        const blockType = workspace.getBlockById(event.blockId)?.type;
        if (blockType && allBlockTypes.includes(blockType)) {
          if (!mostUsed.includes(blockType)) mostUsed.push(blockType);
          recentlyUsed = recentlyUsed.filter(t => t !== blockType);
          recentlyUsed.push(blockType);
          updateToolbox();
        }
      }
    });

    // Generate JSON from workspace
    function generateJSON() {
  var config = { inputs: [], outputs: [] };

  // Process input blocks
  workspace.getTopBlocks(true).forEach(function (block) {
    if (block.type === 'input_block') {
      var inp = {
        name: block.getFieldValue('NAME'),
        pin: +block.getFieldValue('PIN'),
        type: block.getFieldValue('TYPE'),
      };

      // Only add 'pull' to the JSON if it is not 'DNP'
      var pullValue = block.getFieldValue('PULL');
      if (pullValue !== '') {
        inp.pull = pullValue;
      }

      config.inputs.push(inp);
    }
  });

  // Process output blocks independently
  workspace.getAllBlocks().forEach(function (block) {
    if (block.type === 'output_block') {
      var out = {
        name: block.getFieldValue('NAME'),
        pin: +block.getFieldValue('PIN'),
        type: block.getFieldValue('TYPE'),
      };

      // If type is pwm, add channel and frequency to JSON
      if (out.type === 'pwm') {
        out.channel = +block.getFieldValue('CHANNEL');
        out.frequency = +block.getFieldValue('FREQUENCY');
      }

      // Process states
      var stateBlock = block.getInputTargetBlock('STATES');
      var stateIdx = 1;
      while (stateBlock) {
        out['state' + stateIdx] = {};
        var entry = out['state' + stateIdx];
 // Process timers
            var t = stateBlock.getInputTargetBlock('TIMERS');
            while (t) {
              if (t.type === 'timer_action_block') {
                var ti = +t.getFieldValue('TIMER_INDEX'); // Get timer index
                var action = t.getFieldValue('TIMER_ACTION'); // Get timer action
                entry['timer' + ti] = action; // Add to JSON as "timer1": "start"
              } else if (t.type === 'timer_duration_block') {
                var ti = +t.getFieldValue('TIMER_INDEX'); // Get timer index
                var duration = +t.getFieldValue('DURATION'); // Get timer duration
                entry['timer' + ti + 'Duration'] = duration; // Add to JSON as "timer1Duration": 3000
              } else if (t.type === 'timer_adjust_block') {
                var ti = +t.getFieldValue('TIMER_INDEX'); // Get timer index
                var operation = t.getFieldValue('TIMER_OPERATION'); // Get operation
                var value = +t.getFieldValue('TIMER_VALUE'); // Get value
                // Add to JSON based on the selected operation
                if (operation === '+=') {
                  entry['timer' + ti + 'DurationAdd'] = value; // Add to JSON as "timer2DurationAdd": 1000
                } else if (operation === '-=') {
                  entry['timer' + ti + 'DurationSubtract'] = value; // Add to JSON as "timer2DurationSubtract": 1000
                } else if (operation === '=') {
                  entry['timer' + ti + 'Duration'] = value; // Add to JSON as "timer2Duration": 1000
                }
              }
              t = t.getNextBlock();
            }


        // Process flags
        var f = stateBlock.getInputTargetBlock('FLAGS');
        while (f) {
          if (f.type === 'flag_block') {
            var fi = +f.getFieldValue('FLAG_INDEX');
            var flagAction = f.getFieldValue('FLAG_ACTION');
            var flagValue = f.getField('FLAG_VALUE').isVisible()
              ? +f.getFieldValue('FLAG_VALUE')
              : flagAction;

            if (flagAction === '+=') {
              entry['flag' + fi + 'Add'] = flagValue;
            } else if (flagAction === '-=') {
              entry['flag' + fi + 'Subtract'] = flagValue;
            } else if (flagAction === '=') {
              entry['flag' + fi] = flagValue;
            } else if (flagAction === '++') {
              entry['flag' + fi] = '++';
            } else if (flagAction === '--') {
              entry['flag' + fi] = '--';
            } else if (flagAction === '') {
              entry['flag' + fi] = flagValue;
            }
          }
          f = f.getNextBlock();
        }

        // Process state options
        var o = stateBlock.getInputTargetBlock('OPTIONS');
        while (o) {
          // Add each state option as a property in the entry object
          // Example for some common state option blocks:
          if (o.type === 'state_option_output') {
            entry.output = o.getFieldValue('OUTPUT');
          } else if (o.type === 'state_option_duty') {
            entry.duty = +o.getFieldValue('DUTY');
          } else if (o.type === 'state_option_onDuration') {
            entry.onDuration = +o.getFieldValue('ONDUR');
          } else if (o.type === 'state_option_offDuration') {
            entry.offDuration = +o.getFieldValue('OFFDUR');
          } else if (o.type === 'state_option_clearBackground') {
            if(o.getFieldValue('CLEAR') === "TRUE"){
              entry.clearBackground = 1;
            }else{
              entry.clearBackground = 0;
            }
          } else if (o.type === 'state_option_rowMessage') {
            entry['row' + o.getFieldValue('ROW') + 'Message'] = o.getFieldValue('MSG');
          } else if (o.type === 'state_option_font') {
            entry.font = Number(o.getFieldValue('FONT'));
          } else if (o.type === 'state_option_invert') {
            if(o.getFieldValue('INV') === "TRUE"){
              entry.invert = 1;
            }else{
              entry.invert = 0;
            }
          } else if (o.type === 'state_option_color') {
            entry.color = Number(o.getFieldValue('COLOR'));
          } else if (o.type === 'state_option_colorBlink') {
            entry.color1 = Number(o.getFieldValue('C1'));
            entry.color2 = Number(o.getFieldValue('C2'));
            entry.color1Duration = +o.getFieldValue('D1');
            entry.color2Duration = +o.getFieldValue('D2');
          } else if (o.type === 'state_option_brightness') {
            entry.brightness = +o.getFieldValue('BR');
          } else if (o.type === 'state_option_contrast') {
            entry.contrast = +o.getFieldValue('CT');
          } else if (o.type === 'state_option_displayAnalog') {
            if(o.getFieldValue('MODE') === 'voltage'){
                entry.displayAnalogVoltage = {
                pin: +o.getFieldValue('APIN'),
                font: Number(o.getFieldValue('AFONT')),
                row: +o.getFieldValue('AROW')
              };
            } else if(o.getFieldValue('MODE') === 'percent'){
                entry.displayAnalogPercent = {
                pin: +o.getFieldValue('APIN'),
                font: Number(o.getFieldValue('AFONT')),
                row: +o.getFieldValue('AROW')
              };
            } else if(o.getFieldValue('MODE') === 'barGraph'){
                entry.displayAnalogBarGraph = {
                pin: +o.getFieldValue('APIN'),
                font: Number(o.getFieldValue('AFONT')),
                row: +o.getFieldValue('AROW')
              };
            } else if(o.getFieldValue('MODE') === 'fraction'){
                entry.displayAnalogFraction = {
                pin: +o.getFieldValue('APIN'),
                font: Number(o.getFieldValue('AFONT')),
                row: +o.getFieldValue('AROW'),
                levels: +o.getFieldValue('LEVELS_NUM')  
              };
            } else if(o.getFieldValue('MODE') === 'value'){
               entry.displayAnalogValue = {
               pin: +o.getFieldValue('APIN'),
               font: Number(o.getFieldValue('AFONT')),
               row: +o.getFieldValue('AROW')
              };
            }
            
          } else if (o.type === 'state_option_displayTimer') {
            entry.displayTimer = {
              timer: +o.getFieldValue('TIMER'),
              font: Number(o.getFieldValue('FONT')),
              row: +o.getFieldValue('ROW')
            };
          } else if (o.type === 'state_option_displayFlag') {
            entry.displayFlag = {
              flag: +o.getFieldValue('FLAG'),
              font: Number(o.getFieldValue('FONT')),
              row: +o.getFieldValue('ROW')
            };
          } else if (o.type === 'state_option_displayStopwatch') {
            entry.displayStopwatch = {
              font: Number(o.getFieldValue('FONT')),
              row: +o.getFieldValue('ROW')
            };
          } else if (o.type === 'state_option_displayStopwatchDays') {
            entry.displayStopwatchDays = {
              font: Number(o.getFieldValue('FONT')),
              row: +o.getFieldValue('ROW')
            };
          } else if (o.type === 'state_option_bitmap') {
            entry.bitmap = o.getFieldValue('BITMAP');
          } else if (o.type === 'display_image') {
            // Always add the text value as imagePath
            let imgVal = o.getFieldValue('IMG');
            entry.imagePath = '/img/' + imgVal + '.bmp' || "";
          } else if (o.type === 'state_option_stopwatch'){
            entry.stopwatch = o.getFieldValue('STOPWATCH');
          }

          o = o.getNextBlock();
        }

        stateBlock = stateBlock.getNextBlock();
        stateIdx++;
      }

      // Process conditions
    var condBlock = block.getInputTargetBlock('CONDITIONS');
    var condIdx = 1;
    while (condBlock) {
      out['condition' + condIdx] = {};
      var condEntry = out['condition' + condIdx];

      // Example: Add more detailed extraction for your condition_option blocks as needed
      var c = condBlock.getInputTargetBlock('COND_OPTIONS');
      while (c) {
        if (c.type === 'condition_option_pin') {
          condEntry.pin = +c.getFieldValue('PIN');
        } else if (c.type === 'condition_option_state') {
          condEntry.state = c.getFieldValue('STATE');
        } else if (c.type === 'condition_option_threshold') {
          condEntry.threshold = +c.getFieldValue('THRESHOLD');
        } else if (c.type === 'condition_option_comparison') {
          condEntry.comparison = c.getFieldValue('COMPARISON');
        } else if (c.type === 'condition_option_thresholdRange') {
          condEntry.thresholdRange = {
            min: +c.getFieldValue('MIN'),
            max: c.getFieldValue('MAX'),
          };
        } else if (c.type === 'condition_option_thresholdVoltage') {
          condEntry.thresholdVoltage = {
            min: +c.getFieldValue('VMIN'),
            max: c.getFieldValue('VMAX'),
          };
        } else if (c.type === 'condition_option_thresholdPercent') {
          condEntry.thresholdPercent = {
            min: +c.getFieldValue('PMIN'),
            max: c.getFieldValue('PMAX'),
          };
        } else if (c.type === 'condition_option_switch') {
          condEntry.switch = c.getFieldValue('SWITCH_STATE');
        } else if (c.type === 'condition_option_timer') {
          var timer_index = c.getFieldValue('TIMER_NUMBER');
          condEntry['timer' + timer_index] = c.getFieldValue('TIMER_STATE');
        } else if(c.type === 'condition_option_flag'){
          var flag_index = c.getFieldValue('FLAG_INDEX');
          condEntry['flag' + flag_index] = c.getFieldValue('FLAG_VALUE');
        }
        c = c.getNextBlock();
      }

      condBlock = condBlock.getNextBlock();
      condIdx++;
    }

      config.outputs.push(out);
    }
  });

  document.getElementById('jsonPreview').textContent = JSON.stringify(config, null, 2);
  return config;
}

    workspace.addChangeListener(generateJSON);
    document.getElementById('downloadBtn').addEventListener('click', function() {
      var data = generateJSON();
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      const randomName = 'program_' + Math.random().toString(36).substring(2, 10) + '.json';
      a.href = url;
      a.download = randomName;
      a.click();
    });
    // Initialize toolbox on load
    updateToolbox();

    function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;

  // Style the toast
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.right = '20px';
  toast.style.padding = '10px 20px';
  toast.style.borderRadius = '5px';
  toast.style.color = '#fff';
  toast.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
  toast.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
  toast.style.zIndex = '1000';
  toast.style.fontSize = '1rem';

  document.body.appendChild(toast);

  // Remove the toast after 3 seconds
  setTimeout(() => {
    toast.remove();
  }, 3000);
}
  </script>
</body>
</html>









